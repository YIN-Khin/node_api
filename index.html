<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student CRUD</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 30px;
        /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 2em;
      }

      .header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      button {
        padding: 10px 20px;
        margin-right: 5px;
        cursor: pointer;
        border: none;
        border-radius: 8px;
        background: #667eea;
        color: #fff;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
      }

      button:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button.secondary {
        background: #95a5a6;
        box-shadow: 0 2px 5px rgba(149, 165, 166, 0.3);
      }

      button.secondary:hover {
        background: #7f8c8d;
      }

      button.delete-btn {
        background: #e74c3c;
        box-shadow: 0 2px 5px rgba(231, 76, 60, 0.3);
      }

      button.delete-btn:hover {
        background: #c0392b;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      }

      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
      }

      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 1px;
      }

      tr:hover {
        background: #f8f9fa;
      }

      tr:last-child td {
        border-bottom: none;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 450px;
        max-width: 90%;
        position: relative;
        animation: slideDown 0.3s;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-content h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.5em;
      }

      form input,
      form select {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 2px solid #ecf0f1;
        font-size: 14px;
        transition: border 0.3s;
      }

      form input:focus,
      form select:focus {
        outline: none;
        border-color: #667eea;
      }

      form label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .form-buttons button {
        flex: 1;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #95a5a6;
        font-size: 16px;
      }

      .error {
        color: #e74c3c;
        padding: 15px;
        background: #fadbd8;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #e74c3c;
      }

      .success {
        color: #27ae60;
        padding: 15px;
        background: #d4efdf;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #27ae60;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #95a5a6;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-male {
        background: #d6eaf8;
        color: #2874a6;
      }

      .badge-female {
        background: #fadbd8;
        color: #a93226;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header-controls">
        <h1>Student Management</h1>
        <button id="addBtn">Add Student</button>
      </div>

      <div id="errorMsg"></div>
      <div id="successMsg"></div>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Gender</th>
            <th>Date of Birth</th>
            <th>Address</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="students"></tbody>
      </table>
    </div>

    <!-- Modal for Create / Update -->
    <div id="studentModal" class="modal">
      <div class="modal-content">
        <h2 id="modalTitle">Add Student</h2>
        <form id="studentForm">
          <input type="hidden" name="id" />

          <label>Name:</label>
          <input
            type="text"
            name="name"
            placeholder="Enter student name"
            required
          />

          <label>Gender:</label>
          <select name="gender" required>
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>

          <label>Date of Birth:</label>
          <input type="date" name="dob" required />

          <label>Address:</label>
          <input
            type="text"
            name="address"
            placeholder="Enter address"
            required
          />

          <div class="form-buttons">
            <button type="submit">Save</button>
            <button type="button" id="closeModal" class="secondary">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const addBtn = document.getElementById("addBtn");
      const modal = document.getElementById("studentModal");
      const closeModal = document.getElementById("closeModal");
      const form = document.getElementById("studentForm");
      const modalTitle = document.getElementById("modalTitle");
      const tbody = document.getElementById("students");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");

      // Show success message
      function showSuccess(message) {
        successMsg.innerHTML = `<div class="success">‚úÖ ${message}</div>`;
        setTimeout(() => {
          successMsg.innerHTML = "";
        }, 3000);
      }

      // Show error message
      function showError(message) {
        errorMsg.innerHTML = `<div class="error">‚ö†Ô∏è ${message}</div>`;
        setTimeout(() => {
          errorMsg.innerHTML = "";
        }, 5000);
      }

      // Load students function
      async function loadStudents() {
        try {
          tbody.innerHTML =
            '<tr><td colspan="6" class="loading"> Loading students...</td></tr>';
          errorMsg.innerHTML = "";

          const res = await fetch("http://localhost:3000/api/student");

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const json = await res.json();
          tbody.innerHTML = "";

          // Support both ListStudents and listStudent for backend compatibility
          const students = json.ListStudents || json.listStudent || [];

          if (students.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="6" class="empty-state">
                  <div class="empty-state-icon">üì≠</div>
                  <div>No students found. Click "Add Student" to create one!</div>
                </td>
              </tr>`;
            return;
          }

          students.forEach((stu) => {
            const row = document.createElement("tr");
            const genderBadge =
              stu.gender === "Male"
                ? '<span class="badge badge-male">Male</span>'
                : '<span class="badge badge-female">Female</span>';

            row.innerHTML = `
              <td><strong>${stu.id}</strong></td>
              <td>${stu.name}</td>
              <td>${genderBadge}</td>
              <td>${stu.dob}</td>
              <td>${stu.address}</td>
              <td>
                <button class="update-btn" data-id="${stu.id}">Edit</button>
                <button class="delete-btn" data-id="${stu.id}">Delete</button>
              </td>
            `;
            tbody.appendChild(row);
          });
        } catch (err) {
          console.error("Error loading students:", err);
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: #e74c3c;">‚ùå Error loading students</td></tr>';
          showError(
            "Could not load students. Please make sure the server is running on http://localhost:3000"
          );
        }
      }

    
      loadStudents();

      addBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        modalTitle.textContent = "Add New Student";
        form.reset();
        form.querySelector('[name="id"]').value = "";
      });
      closeModal.addEventListener("click", () => {
        modal.style.display = "none";
      });
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        const id = formData.get("id");
        const studentData = {
          name: formData.get("name"),
          gender: formData.get("gender"),
          dob: formData.get("dob"),
          address: formData.get("address"),
        };

        try {
          let response;
          if (id) {
            // Update
            response = await fetch(`http://localhost:3000/api/student/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(studentData),
            });
            showSuccess(`Student "${studentData.name}" updated successfully!`);
          } else {
            // Create
            response = await fetch("http://localhost:3000/api/student", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(studentData),
            });
            showSuccess(`Student "${studentData.name}" created successfully!`);
          }

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          await loadStudents();
          modal.style.display = "none";
        } catch (err) {
          console.error("Error saving student:", err);
          showError("Failed to save student. Please try again.");
        }
      });

      // Delegate buttons
      tbody.addEventListener("click", async function (e) {
        if (e.target.classList.contains("delete-btn")) {
          const id = e.target.dataset.id;
          if (
            confirm(
              "‚ö†Ô∏è Are you sure you want to delete this student? This action cannot be undone."
            )
          ) {
            try {
              const response = await fetch(
                `http://localhost:3000/api/student/${id}`,
                {
                  method: "DELETE",
                }
              );

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              showSuccess("Student deleted successfully!");
              await loadStudents();
            } catch (err) {
              console.error("Error deleting student:", err);
              showError("Failed to delete student. Please try again.");
            }
          }
        }

        if (e.target.classList.contains("update-btn")) {
          const id = e.target.dataset.id;
          console.log("Edit button clicked for ID:", id);

          try {
            const res = await fetch(`http://localhost:3000/api/student/${id}`);

            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }

            const data = await res.json();
            console.log("Received student data:", data);

            // Handle different response formats from backend
            const stu = data.student || data;

            if (!stu || !stu.id) {
              throw new Error("Invalid student data received");
            }

            modal.style.display = "flex";
            modalTitle.textContent = "Update Student";

            // Set the ID in the hidden input
            const idInput = form.querySelector('[name="id"]');
            idInput.value = stu.id;

            form.querySelector('[name="name"]').value = stu.name || "";
            form.querySelector('[name="gender"]').value = stu.gender || "";
            form.querySelector('[name="dob"]').value = stu.dob || "";
            form.querySelector('[name="address"]').value = stu.address || "";

            console.log("Form populated with ID:", idInput.value);
          } catch (err) {
            console.error("Error fetching student:", err);
            showError("Failed to load student data. Please try again.");
          }
        }
      });
    </script>
  </body>
</html>
